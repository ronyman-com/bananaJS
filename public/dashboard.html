<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BananaJS Development Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.8.0/lib/xterm-addon-web-links.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
  <script src="https://kit.fontawesome.com/af67804f51.js" crossorigin="anonymous"></script>

  <style>
    /* Combined and optimized CSS */
    .file-tree {
      max-height: 500px;
      overflow-y: auto;
    }
    .file-tree ul {
      list-style-type: none;
      padding-left: 20px;
    }
    .file-tree li {
      cursor: pointer;
      padding: 5px 0;
      position: relative;
    }
    .file-tree li.folder {
      font-weight: bold;
      color: #ffeb3b;
    }
    .file-tree li.folder::before {
      content: 'üìÅ ';
    }
    .file-tree li.file {
      color: #fff;
    }
    .file-tree li.file::before {
      content: 'üìÑ ';
    }
    .file-tree li .file-actions {
      display: none;
      position: absolute;
      right: 0;
      background: #333;
      padding: 2px 5px;
      border-radius: 3px;
    }
    .file-tree li:hover .file-actions {
      display: inline-block;
    }
    
    /* Enhanced notifications */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      max-width: 400px;
      animation: slideIn 0.3s, fadeOut 0.5s 4.5s forwards;
      cursor: pointer;
    }
    .notification-icon {
      margin-right: 12px;
      font-size: 24px;
    }
    .notification-success {
      background-color: #4CAF50;
      color: white;
    }
    .notification-error {
      background-color: #f44336;
      color: white;
    }
    .notification-info {
      background-color: #2196F3;
      color: white;
    }
    .notification-warning {
      background-color: #ff9800;
      color: white;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      width: 400px;
      max-width: 90%;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 999;
    }
    
    /* Editor styles */
    #editor-container {
      display: none;
      height: calc(100vh - 60px);
    }
    #editor {
      width: 100%;
      height: 100%;
    }
    
    /* Animations */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* Breadcrumbs */
    .breadcrumbs {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      font-size: 0.9em;
    }
    .breadcrumbs button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .breadcrumbs button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Terminal styles */
    #terminal {
      height: 400px;
      width: 100%;
      background: #000;
      border-radius: 4px;
      padding: 10px;
    }
    
    /* Context menu */
    .context-menu {
      position: absolute;
      background: #2d3748;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1001;
      display: none;
    }
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
    }
    .context-menu-item:hover {
      background: #4a5568;
    }
    
    /* Loading spinner */
    .spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .flex {
        flex-direction: column;
      }
      .w-64 {
        width: 100%;
      }
      #terminal {
        height: 300px;
      }
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div class="flex h-screen">
    <!-- Sidebar Navigation -->
    <div class="w-64 bg-gray-800 p-4 overflow-y-auto">
      <h1 class="text-xl font-bold text-yellow-400 mb-6">BananaJS</h1>
      <nav>
        <ul class="space-y-2">
          <li>
            <button onclick="appState.showDashboard()" class="w-full text-left px-3 py-2 rounded bg-gray-700 hover:bg-gray-600 transition-colors">
              <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
            </button>
          </li>
          <li>
            <button onclick="appState.showFileManager()" class="w-full text-left px-3 py-2 rounded hover:bg-gray-700 transition-colors">
              <i class="fas fa-folder-open mr-2"></i> File Manager
            </button>
          </li>
          <li>
            <button onclick="appState.openCreateProjectModal()" class="w-full text-left px-3 py-2 rounded hover:bg-gray-700 transition-colors">
              <i class="fas fa-plus-circle mr-2"></i> New Project
            </button>
          </li>
          <li>
            <button onclick="appState.openCreateAppModal()" class="w-full text-left px-3 py-2 rounded hover:bg-gray-700 transition-colors">
              <i class="fas fa-plus-circle mr-2"></i> New App
            </button>
          </li>
        </ul>
      </nav>
      
      <div class="mt-8 pt-4 border-t border-gray-700">
        <h3 class="text-sm font-semibold text-gray-400 mb-2">Quick Actions</h3>
        <button onclick="appState.restartServer()" class="w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-sm transition-colors mt-1">
          <i class="fas fa-sync-alt mr-2"></i> Restart Server
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-auto">
      <!-- Dashboard Section -->
      <div id="dashboard-section" class="p-6">
        <div class="bg-gray-800 shadow rounded-lg p-6 mb-8">
          <h2 class="text-2xl font-bold text-yellow-400 mb-4">Development Dashboard</h2>
          
          <div id="connection-status" class="p-3 mb-4 rounded bg-yellow-100 text-yellow-800 flex items-center">
            <i class="fas fa-circle-notch fa-spin mr-2"></i>
            <span>Connecting to HMR server...</span>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-300 mb-2">Build Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-sm text-gray-400">Last Build Time</p>
                <p class="font-mono text-white" id="build-time">-- ms</p>
              </div>
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-sm text-gray-400">Last HMR Update</p>
                <p class="font-mono text-white" id="hmr-update-time">-- ms</p>
              </div>
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-sm text-gray-400">Project Size</p>
                <p class="font-mono text-white" id="project-size">--</p>
              </div>
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-sm text-gray-400">Files Count</p>
                <p class="font-mono text-white" id="files-count">--</p>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-gray-300 mb-2">Recent Updates</h3>
            <ul class="space-y-2" id="hmr-updates-list"></ul>
          </div>
        </div>
        
        <div class="bg-gray-800 shadow rounded-lg p-6">
          <h3 class="text-lg font-semibold text-gray-300 mb-4">System Resources</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-400">Memory Usage</span>
                <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded" id="memory-percent">0%</span>
              </div>
              <div class="w-full bg-gray-600 rounded-full h-2.5">
                <div id="memory-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <p class="font-mono text-white text-sm mt-2" id="memory">0 MB / 0 MB</p>
            </div>
            
            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-400">CPU Usage</span>
                <span class="text-xs bg-green-600 text-white px-2 py-1 rounded" id="cpu-percent">0%</span>
              </div>
              <div class="w-full bg-gray-600 rounded-full h-2.5">
                <div id="cpu-bar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <p class="font-mono text-white text-sm mt-2" id="cpu-cores">Cores: 0</p>
            </div>
            
            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-400">Disk Space</span>
                <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded" id="disk-percent">0%</span>
              </div>
              <div class="w-full bg-gray-600 rounded-full h-2.5">
                <div id="disk-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <p class="font-mono text-white text-sm mt-2" id="disk-space">0 GB / 0 GB</p>
            </div>
            
            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-400">Network</span>
                <span class="text-xs bg-yellow-600 text-white px-2 py-1 rounded">Active</span>
              </div>
              <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>‚Üë <span id="network-up">0 KB/s</span></span>
                <span>‚Üì <span id="network-down">0 KB/s</span></span>
              </div>
              <p class="font-mono text-white text-sm mt-2" id="network-status">Connected</p>
            </div>
          </div>
        </div>
      </div>

      <!-- File Manager Section -->
      <div id="file-manager-section" class="hidden p-6">
        <div class="bg-gray-800 shadow rounded-lg p-6 mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-yellow-400">File Management</h2>
            <div>
              <button onclick="appState.refreshFileTree()" class="bg-yellow-400 text-gray-900 px-3 py-1 rounded text-sm font-bold hover:bg-yellow-500 transition mr-2">
                <i class="fas fa-sync-alt mr-1"></i> Refresh
              </button>
              <button onclick="appState.showCreateFileModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-file mr-1"></i> New File
              </button>
              <button onclick="appState.showCreateFolderModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm ml-2">
                <i class="fas fa-folder mr-1"></i> New Folder
              </button>
              <button onclick="appState.showUploadModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm ml-2">
                <i class="fas fa-upload mr-1"></i> Upload
              </button>
            </div>
          </div>
          
          <div class="file-tree bg-gray-700 p-4 rounded">
            <div id="current-path" class="text-gray-400 mb-4 flex items-center">
              <span>Current path: /</span>
              <button onclick="appState.copyCurrentPath()" class="ml-2 text-xs bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded transition">
                <i class="fas fa-copy mr-1"></i> Copy Path
              </button>
            </div>
            <ul id="file-tree" class="text-white"></ul>
          </div>
        </div>

        <!-- Editor Panel -->
        <div id="editor-container" class="bg-gray-800 rounded-lg shadow-lg hidden">
          <div class="bg-gray-900 p-3 flex justify-between items-center rounded-t-lg">
            <div class="flex items-center">
              <span id="editor-filename" class="text-sm font-mono"></span>
              <span id="editor-status" class="text-xs ml-2 px-2 py-1 rounded hidden"></span>
            </div>
            <div>
              <button onclick="appState.saveCurrentFile()" id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm mr-2">
                <i class="fas fa-save mr-1"></i> Save
              </button>
              <button onclick="appState.closeEditor()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-times mr-1"></i> Close
              </button>
            </div>
          </div>
          <div id="editor" style="height: calc(100vh - 150px);"></div>
        </div>
      </div>
      
      <!-- Terminal Section -->
      <div id="terminal-section" class="hidden p-6">
        <div class="bg-gray-800 shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-yellow-400">Terminal</h2>
            <div>
              <button onclick="appState.clearTerminal()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm mr-2">
                <i class="fas fa-trash-alt mr-1"></i> Clear
              </button>
            </div>
          </div>
          <div id="terminal"></div>
          <div class="mt-4 flex">
            <input type="text" id="terminal-input" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded-l focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="Enter command...">
            <button onclick="appState.sendTerminalCommand()" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-r font-bold hover:bg-yellow-500 transition">
              <i class="fas fa-paper-plane mr-1"></i> Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="modal-overlay" class="modal-overlay"></div>
  
  <div id="createProjectModal" class="modal">
    <h3 class="text-xl font-bold text-yellow-400 mb-4">Create Project</h3>
    <input type="text" id="projectName" placeholder="Enter project name" 
           class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
    <div class="flex items-center mb-4">
      <input type="checkbox" id="initGit" class="mr-2">
      <label for="initGit">Initialize Git repository</label>
    </div>
    <div class="flex items-center mb-4">
      <input type="checkbox" id="useYarn" class="mr-2">
      <label for="useYarn">Use Yarn instead of npm</label>
    </div>
    <select id="projectTemplate" class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
      <option value="default">Default</option>
      <option value="react">React</option>
      <option value="vue">Vue</option>
      <option value="node">Node.js</option>
    </select>
    <div class="flex gap-2">
      <button onclick="appState.createProjectWithCLI()" class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded font-bold transition">
        <i class="fas fa-plus-circle mr-1"></i> Create Project
      </button>
      <button onclick="appState.closeModal('createProjectModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-times mr-1"></i> Cancel
      </button>
    </div>
    <div id="cli-output" class="mt-4 p-3 bg-gray-800 rounded font-mono text-sm hidden max-h-40 overflow-y-auto"></div>
  </div>

  <div id="createAppModal" class="modal">
    <h3 class="text-xl font-bold text-yellow-400 mb-4">Create App</h3>
    <input type="text" id="appName" placeholder="Enter app name" 
           class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
    <select id="appTemplate" class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
      <option value="react">React</option>
      <option value="vue">Vue</option>
      <option value="firebase">Firebase</option>
      <option value="docs">Documentation</option>
    </select>
    <div class="flex gap-2">
      <button onclick="appState.createApp()" class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded font-bold transition">
        <i class="fas fa-plus-circle mr-1"></i> Create
      </button>
      <button onclick="appState.closeModal('createAppModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-times mr-1"></i> Cancel
      </button>
    </div>
  </div>

  <!-- Create File Modal -->
  <div id="createFileModal" class="modal">
    <h3 class="text-xl font-bold text-yellow-400 mb-4">Create File</h3>
    <input type="text" id="fileName" placeholder="Enter file name" 
           class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
    <select id="fileTemplate" class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
      <option value="empty">Empty File</option>
      <option value="javascript">JavaScript</option>
      <option value="typescript">TypeScript</option>
      <option value="react">React Component</option>
      <option value="html">HTML</option>
      <option value="css">CSS</option>
    </select>
    <textarea id="fileCustomContent" placeholder="Custom content (optional)" 
              class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none h-32"></textarea>
    <div class="flex gap-2">
      <button onclick="appState.createNewFile()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-file mr-1"></i> Create File
      </button>
      <button onclick="appState.closeModal('createFileModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-times mr-1"></i> Cancel
      </button>
    </div>
  </div>

  <!-- Create Folder Modal -->
  <div id="createFolderModal" class="modal">
    <h3 class="text-xl font-bold text-yellow-400 mb-4">Create Folder</h3>
    <input type="text" id="folderName" placeholder="Enter folder name" 
           class="w-full p-2 mb-4 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-400 focus:outline-none">
    <div class="flex gap-2">
      <button onclick="appState.createNewFolder()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-folder mr-1"></i> Create Folder
      </button>
      <button onclick="appState.closeModal('createFolderModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-times mr-1"></i> Cancel
      </button>
    </div>
  </div>

  <div id="uploadModal" class="modal">
    <h3 class="text-xl font-bold text-yellow-400 mb-4">Upload Files</h3>
    <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center mb-4">
      <input type="file" id="file-upload" class="hidden" multiple>
      <label for="file-upload" class="cursor-pointer">
        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
        <p class="text-gray-300">Drag & drop files here or click to browse</p>
        <p class="text-xs text-gray-500 mt-2">Max file size: 50MB</p>
      </label>
    </div>
    <div id="upload-progress" class="hidden">
      <div class="w-full bg-gray-600 rounded-full h-2.5 mb-2">
        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
      </div>
      <p class="text-xs text-gray-400 text-center" id="upload-status">Preparing to upload...</p>
    </div>
    <div class="flex gap-2">
      <button onclick="appState.startUpload()" id="upload-button" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-upload mr-1"></i> Upload
      </button>
      <button onclick="appState.closeModal('uploadModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded font-bold transition">
        <i class="fas fa-times mr-1"></i> Cancel
      </button>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu">
    <div class="context-menu-item" onclick="appState.contextMenuAction('open')">Open</div>
    <div class="context-menu-item" onclick="appState.contextMenuAction('rename')">Rename</div>
    <div class="context-menu-item" onclick="appState.contextMenuAction('delete')">Delete</div>
    <div class="context-menu-item" onclick="appState.contextMenuAction('download')">Download</div>
    <div class="context-menu-item" onclick="appState.contextMenuAction('copy-path')">Copy Path</div>
  </div>

  <script>
    // Import the FitAddon for terminal resizing
    const { FitAddon } = window;
    
    class AppState {
      constructor() {
        this.ws = null;
        this.currentDirectory = '';
        this.terminal = null;
        this.terminalFitAddon = null;
        this.hmrUpdates = [];
        this.codeEditor = null;
        this.contextMenuTarget = null;
        this.currentFile = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        this.reconnectDelay = 1000;
        this.activeConnection = false;
        this.connectionTimeout = null;
        this.heartbeatInterval = null;
        this.connectionCheckInterval = null;
      }

      init() {
        console.log('Initializing application...');
        this.initWebSocket();
        this.initEditor();
        this.loadFileTree();
        this.setupEventListeners();
        this.showDashboard();

        // Make methods available globally
        window.appState = this;
        window.showDashboard = () => this.showDashboard();
        window.showFileManager = () => this.showFileManager();
        window.showTerminal = () => this.showTerminal();
        window.openCreateProjectModal = () => this.openCreateProjectModal();
        window.openCreateAppModal = () => this.openCreateAppModal();
      }

      showDashboard() {
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('file-manager-section').classList.add('hidden');
        document.getElementById('terminal-section').classList.add('hidden');
      }

      showFileManager() {
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('file-manager-section').classList.remove('hidden');
        document.getElementById('terminal-section').classList.add('hidden');
        this.loadFileTree();
      }

      showTerminal() {
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('file-manager-section').classList.add('hidden');
        document.getElementById('terminal-section').classList.remove('hidden');
        if (!this.terminal) {
          this.initTerminal();
        }
      }

      async refreshFileTree() {
        try {
          this.showNotification('Refreshing file tree...', 'info');
          await this.loadFileTree(this.currentDirectory);
          this.showNotification('File tree refreshed', 'success');
        } catch (error) {
          console.error('Error refreshing file tree:', error);
          this.showNotification('Failed to refresh file tree', 'error');
        }
      }

      showCreateFileModal() {
        document.getElementById('fileName').value = '';
        document.getElementById('fileTemplate').value = 'empty';
        document.getElementById('fileCustomContent').value = '';
        this.openModal('createFileModal');
      }

      showCreateFolderModal() {
        document.getElementById('folderName').value = '';
        this.openModal('createFolderModal');
      }

      showUploadModal() {
        const fileInput = document.getElementById('file-upload');
        if (fileInput) fileInput.value = '';
        document.getElementById('upload-progress').classList.add('hidden');
        document.getElementById('upload-button').disabled = false;
        this.openModal('uploadModal');
      }

      initWebSocket() {
        console.log('Initializing WebSocket connection...');
        this.cleanupWebSocket();

        try {
          const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
          const wsUrl = `${protocol}${window.location.host}/ws`;
          
          console.log(`Connecting to WebSocket at: ${wsUrl}`);
          this.ws = new WebSocket(wsUrl);
          this.activeConnection = true;

          // Set connection timeout (5 seconds)
          this.connectionTimeout = setTimeout(() => {
            if (this.ws && this.ws.readyState === WebSocket.CONNECTING) {
              console.warn('WebSocket connection timeout');
              this.ws.close();
              this.handleConnectionFailure('Connection timeout');
            }
          }, 5000);

          this.ws.onopen = () => {
            clearTimeout(this.connectionTimeout);
            this.reconnectAttempts = 0;
            this.activeConnection = true;
            this.updateConnectionStatus(true);
            console.log('WebSocket connected successfully');
            this.showNotification('Connected to development server', 'success');
            this.startHeartbeat();
            this.startConnectionMonitoring();
          };

          this.ws.onmessage = (event) => {
            try {
              // Handle both terminal output and JSON messages
              if (typeof event.data === 'string' && event.data.includes('\x1b[')) {
                if (this.terminal) this.terminal.write(event.data);
              } else {
                const message = JSON.parse(event.data);
                this.processWebSocketMessage(message);
              }
            } catch (error) {
              console.error('Error processing message:', error);
            }
          };

          this.ws.onclose = (event) => {
            if (!this.activeConnection) return;
            console.log(`WebSocket closed: ${event.code} - ${event.reason}`);
            this.handleConnectionFailure(event.reason || 'Connection closed');
          };

          this.ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            this.handleConnectionFailure(error.message || 'WebSocket error');
          };

        } catch (error) {
          console.error('WebSocket initialization error:', error);
          this.handleConnectionFailure('Initialization failed');
        }
      }

      processWebSocketMessage(message) {
        switch (message.type) {
          case 'hmr-update':
            this.handleHmrUpdate(message);
            break;
          case 'file-change':
            this.handleFileChange(message.path);
            break;
          case 'build-complete':
            this.handleBuildComplete(message.buildTime);
            break;
          case 'terminal-output':
            this.handleTerminalOutput(message.output);
            break;
          case 'metrics':
            this.updateMetrics(message.metrics);
            break;
          case 'pong':
            // Heartbeat response, no action needed
            break;
          default:
            console.log('Unknown message type:', message.type);
        }
      }

      handleConnectionFailure(reason) {
        if (!this.activeConnection) return;
        
        this.activeConnection = false;
        this.updateConnectionStatus(false);
        this.cleanupWebSocket();
        
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
          const delay = this.calculateReconnectDelay();
          console.log(`Attempting reconnect in ${delay}ms (${this.reconnectAttempts + 1}/${this.maxReconnectAttempts})`);
          
          setTimeout(() => {
            this.reconnectAttempts++;
            this.initWebSocket();
          }, delay);
        } else {
          console.error('Max reconnection attempts reached');
          this.showNotification('Failed to connect to server', 'error');
        }
      }

      calculateReconnectDelay() {
        return Math.min(
          this.baseReconnectDelay * Math.pow(2, this.reconnectAttempts),
          30000 // Max 30 second delay
        );
      }

      startHeartbeat() {
        this.stopHeartbeat();
        this.heartbeatInterval = setInterval(() => {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
          }
        }, 25000); // 25 seconds
      }

      startConnectionMonitoring() {
        this.stopConnectionMonitoring();
        this.connectionCheckInterval = setInterval(() => {
          if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            this.handleConnectionFailure('Connection monitoring detected failure');
          }
        }, 10000); // Check every 10 seconds
      }

      cleanupWebSocket() {
        this.activeConnection = false;
        
        // Clear timers
        clearTimeout(this.connectionTimeout);
        this.stopHeartbeat();
        this.stopConnectionMonitoring();

        // Clean up WebSocket
        if (this.ws) {
          // Remove all event listeners
          this.ws.onopen = null;
          this.ws.onmessage = null;
          this.ws.onclose = null;
          this.ws.onerror = null;
          
          // Close if not already closed
          if (this.ws.readyState === WebSocket.OPEN || 
              this.ws.readyState === WebSocket.CONNECTING) {
            try {
              this.ws.close(1000, 'Client cleanup');
            } catch (e) {
              console.error('Error closing WebSocket:', e);
            }
          }
          
          this.ws = null;
        }
      }

      stopHeartbeat() {
        if (this.heartbeatInterval) {
          clearInterval(this.heartbeatInterval);
          this.heartbeatInterval = null;
        }
      }

      stopConnectionMonitoring() {
        if (this.connectionCheckInterval) {
          clearInterval(this.connectionCheckInterval);
          this.connectionCheckInterval = null;
        }
      }

      updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connection-status');
        if (!statusElement) return;

        if (connected) {
          statusElement.innerHTML = `
            <i class="fas fa-check-circle mr-2 text-green-500"></i>
            <span>Connected to development server</span>
          `;
          statusElement.className = 'p-3 mb-4 rounded bg-green-100 text-green-800 flex items-center';
        } else {
          statusElement.innerHTML = `
            <i class="fas fa-sync-alt fa-spin mr-2"></i>
            <span>Connecting to server...</span>
          `;
          statusElement.className = 'p-3 mb-4 rounded bg-yellow-100 text-yellow-800 flex items-center';
        }
      }

      async loadFileTree(directory = '') {
        try {
          this.currentDirectory = directory;
          this.updatePathDisplay(directory);

          const response = await fetch(`/api/files?directory=${encodeURIComponent(directory)}`);
          
          if (!response.ok) {
            throw new Error(await response.text() || 'Failed to load directory');
          }

          const files = await response.json();
          this.renderFileTree(files);
          
        } catch (error) {
          console.error('File tree error:', error);
          this.showNotification(`Failed to load directory: ${error.message}`, 'error');
          this.showErrorState(error.message);
        }
      }

      updatePathDisplay(directory) {
        const pathDisplay = document.getElementById('current-path');
        if (!pathDisplay) return;

        const formattedPath = directory 
          ? `Current path: /${directory.replace(/\\/g, '/')}` 
          : 'Current path: /';
        
        pathDisplay.innerHTML = `
          <span style="color: #a0aec0;">${formattedPath}</span>
          ${directory ? `
          <button onclick="appState.loadFileTree('')" 
                  class="ml-2 text-xs bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded transition">
            Go to root
          </button>
          ` : ''}
          <button onclick="appState.copyCurrentPath()" 
                  class="ml-2 text-xs bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded transition">
            <i class="fas fa-copy mr-1"></i> Copy Path
          </button>
        `;
      }

      renderFileTree(files) {
        const fileTree = document.getElementById('file-tree');
        if (!fileTree) return;

        if (!files || files.length === 0) {
          fileTree.innerHTML = this.getEmptyDirectoryHTML();
          return;
        }

        fileTree.innerHTML = this.getBreadcrumbs() + this.getFileListHTML(files);
        this.setupFileEventListeners();
      }

      getEmptyDirectoryHTML() {
        return `
          <li class="text-gray-400 py-2">
            Empty directory
            <button onclick="appState.showCreateFileModal()"
                    class="ml-2 text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition">
              <i class="fas fa-file mr-1"></i> New File
            </button>
            <button onclick="appState.showCreateFolderModal()"
                    class="ml-2 text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded transition">
              <i class="fas fa-folder mr-1"></i> New Folder
            </button>
          </li>
        `;
      }

      getBreadcrumbs() {
        if (!this.currentDirectory) return '';

        const parts = this.currentDirectory.split('/');
        let breadcrumbHtml = '<li class="breadcrumbs mb-2 pb-2 border-b border-gray-700">';
        
        parts.reduce((acc, part) => {
          const path = acc ? `${acc}/${part}` : part;
          breadcrumbHtml += `
            <span class="text-gray-400">/</span>
            <button onclick="appState.loadFileTree('${path}')" 
                    class="text-yellow-400 hover:text-yellow-300">
              ${part}
            </button>
          `;
          return path;
        }, '');

        return breadcrumbHtml + '</li>';
      }

      getFileListHTML(files) {
        return files
          .sort(this.sortFiles)
          .map(file => this.getFileItemHTML(file))
          .join('');
      }

      sortFiles(a, b) {
        if (a.isDirectory && !b.isDirectory) return -1;
        if (!a.isDirectory && b.isDirectory) return 1;
        return a.name.localeCompare(b.name);
      }

      getFileItemHTML(file) {
        const filePath = this.currentDirectory ? `${this.currentDirectory}/${file.name}` : file.name;
        
        return `
          <li class="flex items-center justify-between py-2 px-3 hover:bg-gray-700 rounded cursor-pointer ${file.isDirectory ? 'folder' : 'file'}" 
              data-path="${filePath}"
              data-name="${file.name}"
              data-type="${file.isDirectory ? 'folder' : 'file'}"
              oncontextmenu="event.preventDefault(); appState.showContextMenu(event, this)">
            <div class="flex items-center">
              ${file.isDirectory ? '<i class="fas fa-folder text-yellow-400 mr-2"></i>' : '<i class="fas fa-file text-white mr-2"></i>'}
              <span class="item-name">${file.name}</span>
            </div>
            <div class="flex items-center">
              ${!file.isDirectory ? `
                <span class="text-xs text-gray-400 mr-2">${this.formatFileSize(file.size)}</span>
                <button onclick="event.stopPropagation(); appState.openFileForEditing('${filePath}')" 
                        class="file-actions text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded mr-2">
                  <i class="fas fa-edit mr-1"></i> Edit
                </button>
              ` : ''}
              ${file.isDirectory ? 
                `<button onclick="event.stopPropagation(); appState.loadFileTree('${filePath}')" 
                        class="file-actions text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">
                  <i class="fas fa-folder-open mr-1"></i> Open
                </button>` : ''}
            </div>
          </li>
        `;
      }

      setupFileEventListeners() {
        document.querySelectorAll('#file-tree li.folder').forEach(item => {
          item.addEventListener('click', (e) => {
            if (!e.target.classList.contains('file-actions') && 
                !e.target.classList.contains('fa-edit') && 
                !e.target.classList.contains('fa-folder-open')) {
              const path = item.getAttribute('data-path');
              this.loadFileTree(path);
            }
          });
        });
      }

      showErrorState(message) {
        document.getElementById('file-tree').innerHTML = `
          <li class="text-red-400 py-2">
            ${message}
            <button onclick="appState.loadFileTree('')" 
                    class="ml-2 text-xs bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded transition">
              <i class="fas fa-home mr-1"></i> Return to root
            </button>
          </li>
        `;
      }

      async createNewFile() {
        const fileName = document.getElementById('fileName').value.trim();
        const template = document.getElementById('fileTemplate').value;
        const customContent = document.getElementById('fileCustomContent').value || '';

        if (!fileName) {
          this.showNotification('Please enter a file name', 'error');
          return;
        }

        try {
          const response = await fetch('/api/create-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              path: this.currentDirectory || 'workspace',
              name: fileName,
              template: template,
              content: customContent
            })
          });

          const result = await response.json();
          
          if (response.ok) {
            this.showNotification('File created successfully', 'success');
            this.closeModal('createFileModal');
            this.refreshFileTree();

            // Open the file for editing if it's a text file
            const textFileExtensions = ['.js', '.jsx', '.ts', '.tsx', '.html', '.css', '.json', '.txt'];
            if (textFileExtensions.some(ext => fileName.endsWith(ext))) {
              const filePath = this.currentDirectory 
                ? `${this.currentDirectory}/${fileName}` 
                : fileName;
              this.openFileForEditing(filePath);
            }
          } else {
            throw new Error(result.error || 'Failed to create file');
          }
        } catch (error) {
          this.showNotification(`Error: ${error.message}`, 'error');
        }
      }

      async createNewFolder() {
        const folderName = document.getElementById('folderName').value.trim();
        
        if (!folderName) {
          this.showNotification('Please enter a folder name', 'error');
          return;
        }

        try {
          const response = await fetch('/api/create-folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              path: this.currentDirectory || 'workspace',
              name: folderName
            })
          });

          const result = await response.json();
          
          if (response.ok) {
            this.showNotification('Folder created successfully', 'success');
            this.closeModal('createFolderModal');
            this.refreshFileTree();
          } else {
            throw new Error(result.error || 'Failed to create folder');
          }
        } catch (error) {
          this.showNotification(`Error: ${error.message}`, 'error');
        }
      }

      async renameFile(path) {
        const newName = prompt('Enter new name:', path.split('/').pop());
        if (!newName) return;

        try {
          const response = await fetch('/api/rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              oldPath: path,
              newName: newName
            })
          });

          const result = await response.json();
          
          if (response.ok) {
            this.showNotification('File renamed successfully', 'success');
            this.refreshFileTree();
          } else {
            throw new Error(result.error || 'Failed to rename file');
          }
        } catch (error) {
          this.showNotification(`Error: ${error.message}`, 'error');
        }
      }

      async deleteFile(path) {
        if (!confirm(`Are you sure you want to delete ${path}?`)) return;

        try {
          const response = await fetch('/api/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              path: path
            })
          });

          const result = await response.json();
          
          if (response.ok) {
            this.showNotification('File deleted successfully', 'success');
            this.refreshFileTree();
          } else {
            throw new Error(result.error || 'Failed to delete file');
          }
        } catch (error) {
          this.showNotification(`Error: ${error.message}`, 'error');
        }
      }

      downloadFile(path) {
        window.open(`/api/download?path=${encodeURIComponent(path)}`, '_blank');
      }

      copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          this.showNotification('Copied to clipboard', 'success');
        }).catch(err => {
          this.showNotification('Failed to copy to clipboard', 'error');
        });
      }

      copyCurrentPath() {
        const path = this.currentDirectory || '/';
        this.copyToClipboard(path);
      }

      initEditor() {
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        
        require(['vs/editor/editor.main'], () => {
          this.codeEditor = monaco.editor.create(document.getElementById('editor'), {
            value: '',
            language: 'javascript',
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: true },
            fontSize: 14,
            scrollBeyondLastLine: false
          });
          
          this.codeEditor.onDidChangeModelContent(() => {
            document.getElementById('editor-status').textContent = 'Unsaved changes';
            document.getElementById('editor-status').className = 'text-xs ml-2 px-2 py-1 rounded bg-yellow-600';
            document.getElementById('editor-status').classList.remove('hidden');
          });
        });
      }

      async openFileForEditing(filePath) {
        try {
          const response = await fetch(`/api/file?path=${encodeURIComponent(filePath)}`);
          if (!response.ok) {
            throw new Error(await response.text() || 'Failed to read file');
          }
          
          const fileContent = await response.text();
          const language = this.getLanguageFromExtension(filePath);
          
          if (this.codeEditor) {
            this.codeEditor.setValue(fileContent);
            monaco.editor.setModelLanguage(this.codeEditor.getModel(), language);
            
            document.getElementById('editor-filename').textContent = filePath;
            document.getElementById('editor-status').classList.add('hidden');
            document.getElementById('editor-container').classList.remove('hidden');
            
            this.currentFile = filePath;
          }
        } catch (error) {
          this.showNotification(`Error opening file: ${error.message}`, 'error');
        }
      }

      async saveCurrentFile() {
        if (!this.codeEditor || !this.currentFile) return;

        try {
          const content = this.codeEditor.getValue();
          const response = await fetch('/api/save-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              path: this.currentFile,
              content: content
            })
          });

          const result = await response.json();
          
          if (response.ok) {
            document.getElementById('editor-status').textContent = 'Saved';
            document.getElementById('editor-status').className = 'text-xs ml-2 px-2 py-1 rounded bg-green-600';
            document.getElementById('editor-status').classList.remove('hidden');
            this.showNotification('File saved successfully', 'success');
          } else {
            throw new Error(result.error || 'Failed to save file');
          }
        } catch (error) {
          this.showNotification(`Error saving file: ${error.message}`, 'error');
        }
      }

      closeEditor() {
        document.getElementById('editor-container').classList.add('hidden');
        this.currentFile = null;
      }

      getLanguageFromExtension(filePath) {
        const extension = filePath.split('.').pop().toLowerCase();
        
        switch (extension) {
          case 'js': return 'javascript';
          case 'jsx': return 'javascript';
          case 'ts': return 'typescript';
          case 'tsx': return 'typescript';
          case 'html': return 'html';
          case 'css': return 'css';
          case 'scss': return 'scss';
          case 'json': return 'json';
          case 'md': return 'markdown';
          case 'py': return 'python';
          default: return 'plaintext';
        }
      }

      openCreateProjectModal() {
        document.getElementById('projectName').value = '';
        document.getElementById('initGit').checked = false;
        document.getElementById('useYarn').checked = false;
        document.getElementById('cli-output').innerHTML = '';
        document.getElementById('cli-output').classList.add('hidden');
        this.openModal('createProjectModal');
      }

      async createProjectWithCLI() {
        const projectName = document.getElementById('projectName').value.trim();
        const initGit = document.getElementById('initGit').checked;
        const useYarn = document.getElementById('useYarn').checked;
        const template = document.getElementById('projectTemplate').value;

        if (!projectName) {
          this.showNotification('Please enter a project name', 'error');
          return;
        }

        try {
          const response = await fetch('/api/create-project', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              name: projectName,
              git: initGit,
              packageManager: useYarn ? 'yarn' : 'npm',
              template: template,
              basePath: 'workspace'
            })
          });

          const result = await response.json();
          
          if (response.ok) {
            this.showNotification(`Project created in workspace: ${projectName}`, 'success');
            this.closeModal('createProjectModal');
            this.loadFileTree('');
          } else {
            throw new Error(result.error || 'Project creation failed');
          }
        } catch (error) {
          this.showNotification(`Error: ${error.message}`, 'error');
        }
      }

      openCreateAppModal() {
        document.getElementById('appName').value = '';
        document.getElementById('appTemplate').value = 'react';
        this.openModal('createAppModal');
      }

      async createApp() {
        const appName = document.getElementById('appName').value.trim();
        const template = document.getElementById('appTemplate').value;
        
        if (!appName) {
          this.showNotification('Please enter an app name', 'error');
          return;
        }

        try {
          this.showNotification(`Creating app "${appName}"...`, 'info');
          
          const response = await fetch('/api/create-app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              appName, 
              template,
              basePath: 'workspace'
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            this.showNotification(`App created in workspace: ${appName}`, 'success');
            this.closeModal('createAppModal');
            this.loadFileTree('');
          } else {
            throw new Error(result.error || 'Failed to create app');
          }
        } catch (error) {
          this.showNotification(`Error: ${error.message}`, 'error');
        }
      }

      runBuild() {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify({
            type: 'build-command',
            command: 'build'
          }));
          this.showNotification('Build process started...', 'info');
        } else {
          this.showNotification('Not connected to server', 'error');
        }
      }

      restartServer() {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify({
            type: 'restart-command'
          }));
          this.showNotification('Server restart initiated...', 'warning');
        } else {
          this.showNotification('Not connected to server', 'error');
        }
      }

      initTerminal() {
        this.terminal = new Terminal({
          cursorBlink: true,
          theme: {
            background: '#1a1a1a',
            foreground: '#ffffff'
          }
        });
        
        this.terminalFitAddon = new FitAddon();
        this.terminal.loadAddon(this.terminalFitAddon);
        
        this.terminal.open(document.getElementById('terminal'));
        this.terminalFitAddon.fit();
        
        this.terminal.onData(data => {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({
              type: 'terminal-input',
              data: data
            }));
          }
        });
        
        window.addEventListener('resize', () => {
          this.terminalFitAddon.fit();
        });
      }

      sendTerminalCommand() {
        const input = document.getElementById('terminal-input');
        const command = input.value.trim();
        
        if (command && this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify({
            type: 'terminal-command',
            command: command
          }));
          input.value = '';
        }
      }

      clearTerminal() {
        if (this.terminal) {
          this.terminal.clear();
        }
      }

      runCommand(command) {
        if (this.terminal && this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify({
            type: 'terminal-command',
            command: command
          }));
        }
      }

      openModal(id) {
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById(id).style.display = 'block';
      }

      closeModal(id) {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById(id).style.display = 'none';
      }

      formatFileSize(bytes) {
        if (typeof bytes !== 'number' || isNaN(bytes)) return '0 B';
        if (!isFinite(bytes)) return '‚àû B';
        if (bytes === 0) return '0 B';
        
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        const size = bytes / Math.pow(1024, i);
        
        return `${size.toFixed(2)} ${sizes[i]}`;
      }
      
      showNotification(message, type = 'info', duration = 5000) {
        const icons = {
          success: 'fa-check-circle',
          error: 'fa-exclamation-circle',
          info: 'fa-info-circle',
          warning: 'fa-exclamation-triangle'
        };
        
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <span class="notification-icon"><i class="fas ${icons[type] || icons.info}"></i></span>
          <span class="notification-message">${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'fadeOut 0.5s forwards';
          notification.addEventListener('animationend', () => {
            notification.remove();
          });
        }, duration);
        
        notification.addEventListener('click', () => {
          notification.style.animation = 'fadeOut 0.3s forwards';
          notification.addEventListener('animationend', () => {
            notification.remove();
          });
        });
      }

      handleHmrUpdate(update) {
        this.hmrUpdates.push(update);
        this.showNotification(`File updated: ${update.file}`, 'info');
        
        if (this.currentFile && this.currentFile.endsWith(update.file)) {
          this.openFileForEditing(this.currentFile);
        }
      }

      handleFileChange(filePath) {
        this.showNotification(`File changed: ${filePath}`, 'info');
        
        const dir = filePath.split('/').slice(0, -1).join('/');
        if (dir === this.currentDirectory || filePath.startsWith(this.currentDirectory)) {
          this.refreshFileTree();
        }
      }

      handleBuildComplete(buildTime) {
        document.getElementById('build-time').textContent = `${buildTime}ms`;
        this.showNotification(`Build completed in ${buildTime}ms`, 'success');
      }

      handleTerminalOutput(output) {
        if (this.terminal) {
          this.terminal.write(output);
        }
      }

      updateMetrics(metrics) {
        // Update memory metrics
        const memoryPercent = Math.round((metrics.memory.used / metrics.memory.total) * 100);
        document.getElementById('memory-percent').textContent = `${memoryPercent}%`;
        document.getElementById('memory-bar').style.width = `${memoryPercent}%`;
        document.getElementById('memory').textContent = 
          `${this.formatFileSize(metrics.memory.used)} / ${this.formatFileSize(metrics.memory.total)}`;
        
        // Update CPU metrics
        const cpuPercent = Math.round(metrics.cpu.usage * 100);
        document.getElementById('cpu-percent').textContent = `${cpuPercent}%`;
        document.getElementById('cpu-bar').style.width = `${cpuPercent}%`;
        document.getElementById('cpu-cores').textContent = `Cores: ${metrics.cpu.cores}`;
        
        // Update disk metrics
        const diskPercent = Math.round((metrics.disk.used / metrics.disk.total) * 100);
        document.getElementById('disk-percent').textContent = `${diskPercent}%`;
        document.getElementById('disk-bar').style.width = `${diskPercent}%`;
        document.getElementById('disk-space').textContent = 
          `${this.formatFileSize(metrics.disk.used)} / ${this.formatFileSize(metrics.disk.total)}`;
        
        // Update network metrics
        document.getElementById('network-up').textContent = `${metrics.network.upload.toFixed(2)} KB/s`;
        document.getElementById('network-down').textContent = `${metrics.network.download.toFixed(2)} KB/s`;
      }

      setupEventListeners() {
        const uploadDropZone = document.querySelector('#uploadModal .border-dashed');
        const fileUpload = document.getElementById('file-upload');
        
        if (uploadDropZone && fileUpload) {
          uploadDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropZone.classList.add('border-yellow-400', 'bg-gray-700');
          });
          
          uploadDropZone.addEventListener('dragleave', () => {
            uploadDropZone.classList.remove('border-yellow-400', 'bg-gray-700');
          });
          
          uploadDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropZone.classList.remove('border-yellow-400', 'bg-gray-700');
            fileUpload.files = e.dataTransfer.files;
          });
          
          uploadDropZone.addEventListener('click', () => {
            fileUpload.click();
          });
        }

        const modalOverlay = document.getElementById('modal-overlay');
        if (modalOverlay) {
          modalOverlay.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
              modal.style.display = 'none';
            });
            modalOverlay.style.display = 'none';
          });
        }

        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            this.saveCurrentFile();
          }
          
          if (e.key === 'Escape' && document.getElementById('modal-overlay').style.display === 'none') {
            this.closeEditor();
          }
        });
      }

      showContextMenu(event, targetElement) {
        event.preventDefault();
        this.contextMenuTarget = targetElement;
        
        const contextMenu = document.getElementById('context-menu');
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${event.pageX}px`;
        contextMenu.style.top = `${event.pageY}px`;
        
        // Close context menu when clicking elsewhere
        const closeMenu = () => {
          contextMenu.style.display = 'none';
          document.removeEventListener('click', closeMenu);
        };
        
        setTimeout(() => {
          document.addEventListener('click', closeMenu);
        }, 100);
      }

      contextMenuAction(action) {
        if (!this.contextMenuTarget) return;
        
        const path = this.contextMenuTarget.getAttribute('data-path');
        const type = this.contextMenuTarget.getAttribute('data-type');
        
        switch (action) {
          case 'open':
            if (type === 'folder') {
              this.loadFileTree(path);
            } else {
              this.openFileForEditing(path);
            }
            break;
          case 'rename':
            this.renameFile(path);
            break;
          case 'delete':
            this.deleteFile(path);
            break;
          case 'download':
            this.downloadFile(path);
            break;
          case 'copy-path':
            this.copyToClipboard(path);
            break;
        }
      }

      async startUpload() {
        const files = document.getElementById('file-upload').files;
        if (files.length === 0) {
          this.showNotification('Please select files to upload', 'error');
          return;
        }

        const progress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('upload-progress-bar');
        const status = document.getElementById('upload-status');
        const uploadButton = document.getElementById('upload-button');

        progress.classList.remove('hidden');
        uploadButton.disabled = true;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append('files', files[i]);
        }
        
        // Include target directory
        formData.append('directory', this.currentDirectory || 'workspace');

        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(await response.text());
          }

          const result = await response.json();
          this.showNotification(`${result.files.length} files uploaded successfully`, 'success');
          this.closeModal('uploadModal');
          this.refreshFileTree();
        } catch (error) {
          console.error('Upload error:', error);
          this.showNotification(`Upload failed: ${error.message}`, 'error');
        } finally {
          progress.classList.add('hidden');
          uploadButton.disabled = false;
        }
      }
    }

    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.WebSocket) {
        const error = 'WebSocket not supported in this browser';
        console.error(error);
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
          statusElement.innerHTML = `
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>${error}</span>
          `;
        }
        return;
      }

      try {
        const appState = new AppState();
        appState.init();
        
        // Add reconnect button to connection status
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
          const reconnectBtn = document.createElement('button');
          reconnectBtn.className = 'ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded';
          reconnectBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Reconnect';
          reconnectBtn.onclick = () => {
            console.log('Manual reconnect triggered');
            appState.initWebSocket();
          };
          statusElement.appendChild(reconnectBtn);
        }
      } catch (error) {
        console.error('Initialization error:', error);
        const errorElement = document.createElement('div');
        errorElement.className = 'p-4 bg-red-100 text-red-800';
        errorElement.innerHTML = `
          <i class="fas fa-exclamation-triangle mr-2"></i>
          <span>Application failed to initialize: ${error.message}</span>
        `;
        document.body.prepend(errorElement);
      }
    });
  </script>
</body>
</html>